<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria Coworking Odontológico</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FBF8E9', 
                        secondary: '#FBF8E9', 
                        accent: '#996E5C', 
                        textdark: '#89878C', 
                        textlight: '#FBF8E9' 
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos mantidos para visualização correta */
        body { box-sizing: border-box; color: #89878C; }
        .logo-principal { font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; font-weight: 700; text-transform: lowercase; }
        .logo-secundaria { font-family: ui-sans-serif, system-ui, sans-serif; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; }
        .gradient-bg { background: linear-gradient(135deg, #FBF8E9 0%, #EFEBE0 100%); }
        .card-hover, .button-effect { transition: all 0.4s ease; position: relative; overflow: hidden; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 0 10px rgba(182, 224, 198, 0.5); }
        .calendar-day { transition: all 0.2s ease; }
        .calendar-day:hover { background-color: #e0f2fe; }
        .occupied { background-color: #fecaca !important; color: #991b1b; }
        .selected { background-color: #06B6D4 !important; color: white; font-weight: bold; }
        .tooltip { position: relative; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #3C403B; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 12px; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #3C403B transparent transparent transparent; }
    </style>
    
    <script>
        // 1. CONFIGURAÇÃO E INICIALIZAÇÃO DO FIREBASE
        // ⚠️ ATENÇÃO: SUBSTITUA PELA SUA CHAVE REAL.
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI", // <--- TROQUE ESTE VALOR PELO SEU REAL
            authDomain: "mari-projeto-f5877.firebaseapp.com",
            projectId: "mari-projeto-f5877",
            storageBucket: "mari-projeto-f5877.firebasestorage.app",
            messagingSenderId: "360074059778",
            appId: "1:360074059778:web:e42b2d8b6d18cf7992071b",
            measurementId: "G-DPNMK7E2KB"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);

        let selectedDate = null;
        let selectedPlan = null;
        let selectedPlanPrice = 0;
        let occupiedSlots = {}; 
        let calendarLoaded = false;
        
        // 2. BUSCA DADOS DO FIREBASE
        async function fetchOccupiedSlots() {
            try {
                const snapshot = await db.collection("reservations").get(); 
                
                occupiedSlots = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.date; 
                    if (!occupiedSlots[date]) occupiedSlots[date] = [];
                    occupiedSlots[date].push({
                        time: data.time,
                        client: data.clientDescription || "Ocupado"
                    });
                });
                
                generateCalendar(); 
                calendarLoaded = true;
                
            } catch (error) {
                console.error("ERRO FIREBASE. Verifique API Key e Regras.", error);
                // Contingência: se falhar, gera o calendário vazio
                generateCalendar(); 
                calendarLoaded = true;
            }
        }

        // 3. FUNÇÃO DE GERAÇÃO DO CALENDÁRIO (Agora deve aparecer mesmo com erro do Firebase)
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startingDayOfWeek = firstDay.getDay(); 
            
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            let calendarHTML = `
                <div class="text-center mb-4">
                    <h5 class="text-lg font-semibold">${monthNames[currentMonth]} ${currentYear}</h5>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center text-sm font-medium text-gray-500 p-2">Dom</div>
                    <div class="text-center text-sm font-medium text-gray-500 p-2">Seg</div>
                    <div class="text-center text-sm font-medium text-gray-500 p-2">Ter</div>
                    <div class="text-center text-sm font-medium text-gray-500 p-2">Qua</div>
                    <div class="text-center text-sm font-medium text-gray-500 p-2">Qui</div>
                    <div class="text-center text-sm font-medium text-gray-500 p-2">Sex</div>
                    <div class="text-center text-sm font-medium text-gray-500 p-2">Sáb</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateString = date.toISOString().split('T')[0];
                
                const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const currentDayOnly = new Date(currentYear, currentMonth, day);
                const isPast = currentDayOnly < todayOnly; 
                
                const dayOccupied = occupiedSlots[dateString];
                const hasOccupied = dayOccupied && dayOccupied.length > 0;
                
                let dayClass = 'calendar-day p-2 text-center cursor-pointer rounded-lg';
                let tooltipContent = '';
                
                if (isPast) {
                    dayClass += ' text-gray-400 cursor-not-allowed';
                } else if (hasOccupied) {
                    dayClass += ' bg-yellow-100 text-yellow-800 tooltip';
                    const occupiedInfo = dayOccupied.map(slot => {
                        if (slot.client.includes('Manhã')) return 'Manhã (08h-12h)';
                        if (slot.client.includes('Tarde')) return 'Tarde (13h-17h)';
                        if (slot.client.includes('Dia Completo')) return 'Dia Completo';
                        return `${slot.time}`;
                    });
                    const uniqueInfo = [...new Set(occupiedInfo)];
                    tooltipContent = `<span class="tooltiptext">Ocupado: ${uniqueInfo.join(', ')}</span>`;
                } else {
                    dayClass += ' hover:bg-primary hover:bg-opacity-50'; 
                }
                
                calendarHTML += `<div class="${dayClass}" onclick="${!isPast ? `selectDate('${dateString}', this)` : ''}">${day}${tooltipContent}</div>`;
            }
            
            calendarHTML += '</div>';
            calendar.innerHTML = calendarHTML;
        }

        function selectDate(dateString, element) {
            document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
            element.classList.add('selected');
            selectedDate = dateString;
            updateTimeSlots();
        }

        // 4. SELEÇÃO DE PLANO E ATUALIZAÇÃO DE HORÁRIOS
        function selectPlan(plan, price) {
            selectedPlan = plan;
            selectedPlanPrice = price;
            
            const planNames = {
                'hora': 'Por Hora - R$ 70,00',
                'turno': 'Por Turno - R$ 150,00',
                'dia': 'Dia Completo - R$ 300,00'
            };
            
            document.getElementById('selectedPlan').textContent = planNames[plan];
            
            // ⚠️ ESSENCIAL: Recalcula o total com o novo preço base do plano
            calculateTotal(); 
            updateTimeSlots(); 
            
            document.getElementById('booking').scrollIntoView({ behavior: 'smooth' });
        }

        function updateTimeSlots() {
            const timeSlot = document.getElementById('timeSlot');
            
            if (!selectedPlan) {
                timeSlot.innerHTML = '<option value="">Selecione um plano no topo</option>';
                return;
            }
            if (!selectedDate) {
                timeSlot.innerHTML = '<option value="">Selecione a data no calendário</option>';
                return;
            }

            const occupiedSlots_day = occupiedSlots[selectedDate] || [];
            
            let options = '<option value="">Selecione o horário</option>';
            
            if (selectedPlan === 'hora') {
                const hours = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];
                hours.forEach(hour => {
                    if (!occupiedSlots_day.some(slot => slot.time === hour)) {
                        options += `<option value="${hour}">${hour} (1 hora)</option>`;
                    }
                });
            } else if (selectedPlan === 'turno') {
                const morningOccupied = occupiedSlots_day.some(slot => slot.client.includes('Manhã') || slot.client.includes('Dia Completo'));
                const afternoonOccupied = occupiedSlots_day.some(slot => slot.client.includes('Tarde') || slot.client.includes('Dia Completo'));
                
                if (!morningOccupied) options += '<option value="08:00">Turno Manhã (08h às 12h)</option>';
                if (!afternoonOccupied) options += '<option value="13:00">Turno Tarde (13h às 17h)</option>';
            } else if (selectedPlan === 'dia') {
                const dayOccupied = occupiedSlots_day.length > 0;
                if (!dayOccupied) options += '<option value="08:00">Dia Completo (08h às 18h)</option>';
            }
            
            timeSlot.innerHTML = options;
        }

        // 5. CÁLCULO DO TOTAL (Incluindo a regra de horas/planos)
        function calculateTotal() {
            let total = selectedPlanPrice;
            
            // Define o multiplicador de horas com base no plano selecionado
            let hours = selectedPlan === 'hora' ? 1 : (selectedPlan === 'turno' ? 4 : (selectedPlan === 'dia' ? 10 : 0));
            
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                // Lógica de soma de equipamentos: multiplica por 'hours' ou usa preço fixo
                switch(checkbox.value) { 
                    case 'fotopolimerizador': total += 5 * hours; break;
                    case 'ultrassom': total += 5 * hours; break;
                    case 'autoclave': total += 20; break; 
                    case 'laser': total += 20 * hours; break;
                    case 'raioX': total += 50 * hours; break;
                    case 'kitDentistica': total += 20 * hours; break;
                    case 'kitProtese': total += 30 * hours; break;
                    case 'kitCirurgia': total += 80; break; 
                    case 'kitClareamentoConsultorio': total += 65 * hours; break;
                    case 'kitClareamentoCaseiro': total += 90; break; 
                }
            });
            
            document.getElementById('totalPrice').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }
        
        // 6. FLUXO DE PAGAMENTO E CONFIRMAÇÃO DE AGENDAMENTO
        function confirmPayment() {
            closePixModal();
            
            const timeSlot = document.getElementById('timeSlot').value;
            const clientName = document.getElementById('clientName').value;
            // ... (coleta dos demais dados) ...
            const selectedTimeText = document.getElementById('timeSlot').selectedOptions[0].text;
            const totalAmountText = document.getElementById('totalPrice').textContent;
            const totalAmount = parseFloat(totalAmountText.replace('R$', '').replace(',', '.').trim());
            
            const selectedEquipment = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                // ... (coleta dos nomes dos equipamentos) ...
            });
            
            // Definição da descrição da reserva para o calendário (bloqueio de slots)
            let clientDescription = selectedPlan; 
            if (selectedPlan === 'hora') clientDescription = `${clientName} - ${selectedTimeText}`;
            if (selectedPlan === 'turno') clientDescription = `${clientName} - ${selectedTimeText.includes('Manhã') ? 'Turno Manhã' : 'Turno Tarde'}`;
            if (selectedPlan === 'dia') clientDescription = `${clientName} - Dia Completo`;
            
            // DADOS PARA SALVAR NO FIRESTORE
            const reservationData = {
                // ... (campos de dados do cliente) ...
                date: selectedDate, // ⚠️ A data salva que bloqueia o dia no calendário
                time: timeSlot,
                clientDescription: clientDescription, 
                plan: selectedPlan,
                totalAmount: totalAmount,
                equipment: selectedEquipment,
                paymentStatus: 'Aguardando PIX', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            // SALVA NO FIRESTORE
            db.collection("reservations").add(reservationData) 
                .then((docRef) => {
                    console.log("Reserva salva com ID:", docRef.id);
                    // Aqui você colocaria o envio de email
                    
                    document.getElementById('confirmationEmail').textContent = document.getElementById('email').value;
                    document.getElementById('successModal').classList.remove('hidden');
                    document.getElementById('successModal').classList.add('flex');
                    
                })
                .catch((error) => {
                    console.error("Erro ao salvar reserva no Firestore:", error);
                    alert("Erro ao finalizar reserva. Erro: " + error.message);
                });
        }
        
        // Funções Auxiliares (Modais)
        function closePixModal() { /* ... */ }
        function closeSuccessModal() { /* ... */ }
        function copyPixKey() { /* ... */ }
        function scrollToBooking() { /* ... */ }

        // 7. INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', function() {
            fetchOccupiedSlots(); 
            
            // Contingência para garantir que o calendário apareça em 3 segundos
            setTimeout(() => { if (!calendarLoaded) generateCalendar(); }, 3000);

            // Listeners para submissão do formulário
            document.getElementById('bookingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (!selectedDate || !selectedPlan || !document.getElementById('timeSlot').value) {
                    alert('Por favor, selecione uma data, um plano e um horário.');
                    return;
                }
                
                const total = document.getElementById('totalPrice').textContent;
                document.getElementById('pixAmount').textContent = total;
                
                document.getElementById('pixModal').classList.remove('hidden');
                document.getElementById('pixModal').classList.add('flex');
            });

            // ⚠️ LISTENERS PARA EQUIPAMENTOS: A CADA CLIQUE, RECALCULA O TOTAL!
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', calculateTotal);
            });
        });
    </script>
    
</head>
<body>
    <section id="services" class="py-16 bg-gray-50">
        <div class="container mx-auto px-6">
            <h3 class="text-4xl font-bold text-center text-textdark mb-12">Valores e Serviços</h3>
            <div class="grid md:grid-cols-3 gap-8 mb-12">
                <div class="..."><button onclick="selectPlan('hora', 70)">Selecionar</button></div>
                <div class="..."><button onclick="selectPlan('turno', 150)">Selecionar</button></div>
                <div class="..."><button onclick="selectPlan('dia', 300)">Selecionar</button></div>
            </div>
        </div>
    </section>

    <section id="booking" class="py-16 bg-secondary"> 
        <div class="container mx-auto px-6">
            <div class="max-w-4xl mx-auto">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <div id="calendar" class="bg-gray-50 rounded-lg p-4">Carregando Calendário...</div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <form id="bookingForm" class="space-y-4">
                            <div id="selectedPlan" class="px-4 py-2 bg-accent text-white rounded-lg">Selecione um plano acima</div>
                            
                            <select id="timeSlot" required class="w-full ..."><option value="">Selecione data e plano primeiro</option></select>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Equipamentos e Materiais Adicionais</label>
                                <div class="space-y-2 max-h-40 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-200">
                                    <label class="flex items-center text-sm"><input type="checkbox" value="fotopolimerizador" class="mr-2 text-accent focus:ring-accent"> Fotopolimerizador (R$ 5,00/h)</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" value="ultrassom" class="mr-2 text-accent focus:ring-accent"> Ultrassom e jato (R$ 5,00/h)</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" value="autoclave" class="mr-2 text-accent focus:ring-accent"> Autoclave (R$ 20,00/ciclo)</label>
                                    </div>
                            </div>
                            
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="font-semibold text-textdark">Total:</span>
                                    <span id="totalPrice" class="text-2xl font-bold text-accent">R$ 0,00</span>
                                </div>
                                <button type="submit" class="w-full bg-accent text-white py-3 rounded-lg hover:bg-cyan-600 transition-colors font-semibold button-effect">Pagar com PIX</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="pixModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <p class="text-lg font-semibold text-textdark">Valor: <span id="pixAmount" class="text-accent">R$ 0,00</span></p>
            </div>
            <button onclick="confirmPayment()" class="flex-1 bg-accent text-white py-3 rounded-lg hover:bg-cyan-600 transition-colors button-effect">
                Confirmar Pagamento
            </button>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        </div>
</body>
</html>